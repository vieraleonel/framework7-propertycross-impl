<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. 
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />
    -->
    <!-- Good default declaration:
    * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
    * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
    * Disables use of eval() and inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
        * Enable inline JS: add 'unsafe-inline' to default-src
        * Enable eval(): add 'unsafe-eval' to default-src
    * Create your own at http://cspisawesome.com
    -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' https://ssl.gstatic.com; style-src 'self' 'unsafe-inline'; media-src *" /> -->
    <title>PropertyCross</title>

    <link rel="stylesheet" href="assets/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
    <!-- Status bar overlay for full screen mode (PhoneGap) -->
    <div class="statusbar-overlay"></div>

    <!-- Panels overlay-->
    <div class="panel-overlay"></div>

    <!-- Views -->
    <div class="views">
        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main navbar-fixed">

            <div class="pages">
                <!-- Page, "data-page" contains page name -->
                <div class="page" data-page="main">
                    
                    <!-- Top Navbar-->
                    <div class="navbar">
                        <div class="navbar-inner">
                            <div class="center">PropertyCross</div>
                            <div class="right">
                                <a href="#" class="link">Faves</a>
                            </div>
                        </div>
                    </div>

                    <!-- Scrollable page content -->
                    <div class="page-content">
                        <div class="content-block">
                            Use the form below to search for houses to buy. You can search by place-name, postcode, or click 'My location', to search in your current location!
                        </div>
                        <div id="search-form" class="list-block">
                            <div class="content-block">
                                <ul>
                                    <li>
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-input">
                                                    <input id="search-text" type="text" name="search" placeholder="search">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                
                        <div id="search-buttons" class="content-block">
                            <div class="row">
                                <div class="col-45">
                                    <a id="do-search" href="#" class="button button-big button-fill color-green">Go</a>
                                </div>
                                <div class="col-45">
                                    <a href="#" class="button button-big button-fill">My location</a>
                                </div>
                            </div>   
                        </div>

                        <div id="search-progress" class="content-block hidden">
                            <p><span class="progressbar-infinite"></span></p>
                        </div>
                        
                        <div class="state-place"></div>
                </div>
            </div>

        </div>
    </div>

    <script id="recent-searchs-template" type="text/template7">
        <div class="content-block-title">Recent searches:</div>
            <div class="list-block">
                <ul class="recent-searchs">
                    {{#each searchs}}
                        <li class="item-content">
                            <div class="item-inner">
                                <div class="item-title">{{term}}</div>
                                <div class="item-after"><span class="badge">{{results}}</span></div>
                            </div>
                        </li>
                    {{/each}}
                </ul>
            </div>
        </div>
    </script>
    
    <script type="text/javascript" src="assets/lodash/lodash.min.js"></script>

    <!-- storage -->
    <script type="text/javascript" src="assets/localforage/localforage.min.js"></script>
    <script type="text/javascript">
        var storageService = (function(localforage, _){
            var service = {};

            function createRecentSearchs(search) {
                search.date = new Date().toISOString();
                return [search];
            }

            function addSearch(recentSearchs, search) {

                // try to find term
                var index = _.findIndex(recentSearchs, ['term', search.term]);
                
                // update date or insert
                if (index > -1) {
                    recentSearchs[index].date = new Date().toISOString();
                }
                else {
                    search.date = new Date().toISOString();
                    recentSearchs.push(search);
                }

                // order
                recentSearchs = _.reverse(_.sortBy(recentSearchs, ['date']));
                
                // persit only 6 elements
                localforage.setItem('recentSearchs', _.slice(recentSearchs, 0, 6));
            }

            service.addRecentSearch = function(search) {
                localforage.getItem('recentSearchs')
                    .then(function(recentSearchs){
                        if (recentSearchs === null) {
                            localforage.setItem('recentSearchs', createRecentSearchs(search));
                        } else {
                            addSearch(recentSearchs, search);
                        }
                    });
            };

            service.getRecentSearchs = function() {
                return localforage.getItem('recentSearchs');
            };

            service.destroyRecentSearchs = function() {
                localforage.setItem('recentSearchs', null);
            }

            return service;
        })(localforage, _);
    </script>

    <!-- Framework7 -->
    <script type="text/javascript" src="assets/framework7/js/framework7.min.js"></script>
    
    <!-- init.js -->
    <script type="text/javascript">
        
        (function (F7, T7, D7) {
            'use strict';

            window.isAndroid = F7.prototype.device.android === true;
            window.isIos     = F7.prototype.device.ios === true;

            T7.global = {
                android: isAndroid,
                ios: isIos
            };

            window['$$'] = D7;

            if (isAndroid) {
                $$('head').append(
                    '<link rel="stylesheet" href="assets/framework7/css/framework7.material.min.css">' +
                    '<link rel="stylesheet" href="assets/framework7/css/framework7.material.colors.min.css">' +
                    '<link rel="stylesheet" href="assets/css/android.css">'
                );
            }
            else {
                $$('head').append(
                    '<link rel="stylesheet" href="assets/framework7/css/framework7.ios.min.css">' +
                    '<link rel="stylesheet" href="assets/framework7/css/framework7.ios.colors.min.css">' +
                    '<link rel="stylesheet" href="assets/css/ios.css">'  
                );

                // Change class
                $$('.view.navbar-fixed').removeClass('navbar-fixed').addClass('navbar-through');

                // android navbar
                $$('.navbar').prependTo('.view');
            }
        })(Framework7, Template7, Dom7);
    </script>

    <script type="text/javascript" src="assets/js/nestoria-api.js"></script>
    
    <!-- app.js -->
    <script>
        (function (F7, T7, $$, ss) {
            'use strict';

            var template = $$('#recent-searchs-template').html();
            window.recentSearchsCompiled = T7.compile(template);

            ss.getRecentSearchs()
                .then(function(recentSearchs){
                    window.rr = recentSearchs;
                    var html = recentSearchsCompiled({searchs: recentSearchs});
                    $$('.state-place').html(html);
                });
            
            // Initialize app
            window.app = new F7({
                material: isAndroid ? true : false,
                //pushState: true,
                template7Pages: true
            });
            
            // Add view
            window.mainView = app.addView('.view-main', {
                // Because we want to use dynamic navbar, we need to enable it for this view:
                dynamicNavbar: true
            });
        })(Framework7, Template7, Dom7, storageService);
    </script>

    <script type="text/javascript" src="assets/js/main.js"></script>
    <script type="text/javascript" src="assets/js/results.js"></script>

    <!-- property-detail.js -->
    <script type="text/javascript">
        (function (T7, app) {
            'use strict';

            T7.registerHelper('trimPropertyTitle', function(title){
                var split = title.split(',');
                
                if (split.length > 1) {
                    return split[0] + ', ' + split[1];
                } else {
                    return split[0];
                }
            });

            function toggleFav() {
                var $$elem = $$('.fav-property i');

                if ($$elem.hasClass('fa-star-o')) {
                    $$elem.removeClass('fa-star-o');
                    $$elem.addClass('fa-star');
                } else {
                    $$elem.removeClass('fa-star');
                    $$elem.addClass('fa-star-o');
                }
            }

            app.onPageInit('property-details', function(page) {
                $$('.fav-property').on('click', function(event){
                    event.preventDefault();

                    toggleFav();
                });
            });
        })(Template7, app);   
    </script>

    <!-- 
        TODO:
        ===========
        - Intial page (gps, errores, recent)
        - Favourites page
        - Error en resutls loading more
        - Ver "back" para android (físico y navbar)
    -->
</body>

</html>